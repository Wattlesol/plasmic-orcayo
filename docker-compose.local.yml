version: '3.8'

services:
  # Plasmic WAB (Web App Builder) - Local Development
  plasmic-wab:
    build:
      context: .
      dockerfile: ./Dockerfile.prod
      target: production  # Use production stage as base but override for development
    platform: linux/arm64  # Specify ARM64 platform for M1 Mac
    command: |
      sh -c "
        cd /plasmic/platform/wab &&
        # Set up database connection
        jq '(.host = \"plasmic-db\") | (.password //= \"SEKRET\")' ormconfig.json > /tmp/tmp.json &&
        mv /tmp/tmp.json ormconfig.json &&
        # Run migrations
        yarn typeorm migration:run &&
        # Start development server
        cd /plasmic &&
        yarn dev
      "
    volumes:
      # Mount your local source code into the container for live development
      - .:/plasmic
      # Use named volumes to preserve node_modules and build artifacts
      - plasmic_node_modules:/plasmic/node_modules
      - plasmic_wab_node_modules:/plasmic/platform/wab/node_modules
      - plasmic_sub_node_modules:/plasmic/platform/sub/node_modules
      - plasmic_canvas_node_modules:/plasmic/platform/canvas-packages/node_modules
      - plasmic_live_frame_node_modules:/plasmic/platform/live-frame/node_modules
      - plasmic_react_web_bundle_node_modules:/plasmic/platform/react-web-bundle/node_modules
      - plasmic_loader_bundle_env_node_modules:/plasmic/platform/loader-bundle-env/node_modules
      - plasmic_loader_html_hydrate_node_modules:/plasmic/platform/loader-html-hydrate/node_modules
      # Preserve built files
      - plasmic_public:/plasmic/platform/wab/public
      - plasmic_wab_client:/plasmic/platform/wab/src/wab/client
      - plasmic_wab_gen:/plasmic/platform/wab/src/wab/gen
      - plasmic_wab_shared_model:/plasmic/platform/wab/src/wab/shared/model
      - plasmic_generated_styles:/plasmic/platform/wab/src/wab/styles
      # Playwright cache
      - plasmic_playwright_cache:/home/plasmic/.cache/ms-playwright
    ports:
      - "3003:3003"  # Frontend
      - "3004:3004"  # Backend
      - "3005:3005"  # Host server
      - "9229:9229"  # Debugging
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - WAB_DBHOST=${WAB_DBHOST}
      - WAB_DBNAME=${WAB_DBNAME}
      - WAB_DBPASSWORD=${WAB_DBPASSWORD}
      - WAB_DBUSER=${WAB_DBUSER}
      - WAB_DBPORT=${WAB_DBPORT}
      - REDIS_URL=${REDIS_URL}
      - NODE_ENV=development
      - CMS_INTEGRATION_API_KEY=${CMS_INTEGRATION_API_KEY}
      - SESSION_SECRET=${SESSION_SECRET}
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost:3003}
      - PLASMIC_DEPLOYMENT_ENV=development
      # File watching for M1 Mac
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    extra_hosts:
      - "host.docker.internal:host-gateway"  # For connecting to external services
    tty: true
    stdin_open: true
    # Increase resources for development
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 2G

  # Database service
  plasmic-db:
    image: postgres:13
    platform: linux/arm64  # ARM64 compatibility
    restart: always
    environment:
      POSTGRES_DB: ${WAB_DBNAME:-wab}
      POSTGRES_USER: ${WAB_DBUSER:-wab}
      POSTGRES_PASSWORD: ${WAB_DBPASSWORD:-SEKRET}
    ports:
      - "543:5432"  # Expose for local access
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=1GB

volumes:
  postgres_data:
  minio_data:
  plasmic_node_modules:
  plasmic_wab_node_modules:
  plasmic_sub_node_modules:
  plasmic_canvas_node_modules:
  plasmic_live_frame_node_modules:
  plasmic_react_web_bundle_node_modules:
  plasmic_loader_bundle_env_node_modules:
  plasmic_loader_html_hydrate_node_modules:
  plasmic_playwright_cache:
  plasmic_public:
  plasmic_wab_client:
  plasmic_wab_gen:
  plasmic_wab_shared_model:
  plasmic_generated_styles: